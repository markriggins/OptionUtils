<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
    h3 { margin: 0 0 16px 0; color: #137333; }
    .summary { background: white; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 13px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
    .question { background: #e8f0fe; border-radius: 8px; padding: 16px; margin-bottom: 16px; font-size: 14px; color: #1a73e8; }
    .buttons { text-align: right; }
    .buttons button { padding: 10px 24px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 8px; }
    #noBtn { background: white; border: 1px solid #dadce0; color: #5f6368; }
    #noBtn:hover { background: #f1f3f4; }
    #yesBtn { background: #1a73e8; border: none; color: white; }
    #yesBtn:hover { background: #1557b0; }
    #yesBtn:disabled { background: #dadce0; cursor: not-allowed; }
    .status { margin-top: 12px; padding: 12px; border-radius: 4px; font-size: 13px; display: none; }
    .status.info { background: #e8f0fe; color: #1a73e8; display: block; }
    .status.success { background: #e6f4ea; color: #137333; display: block; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #1a73e8; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h3>Option Prices Refreshed</h3>
  <div class="summary" id="summary"></div>

  <div class="question" id="questionSection" style="display:none;">
    A Portfolio sheet exists. Would you like to refresh its price formulas with the new data?
  </div>

  <div id="status" class="status"></div>

  <div class="buttons">
    <button id="noBtn" onclick="google.script.host.close()">Close</button>
    <button id="yesBtn" onclick="refreshPortfolio()" style="display:none;">Refresh Portfolio</button>
  </div>

  <script>
    function init(data) {
      document.getElementById('summary').innerText = data.summary;

      if (data.hasPortfolio) {
        document.getElementById('questionSection').style.display = 'block';
        document.getElementById('yesBtn').style.display = 'inline-block';
      }
    }

    function refreshPortfolio() {
      console.log('refreshPortfolio called');
      try {
        document.getElementById('yesBtn').disabled = true;
        document.getElementById('noBtn').disabled = true;
        document.getElementById('status').className = 'status info';
        document.getElementById('status').innerHTML = '<span class="spinner"></span>Refreshing Portfolio formulas...';

        google.script.run
          .withSuccessHandler(onSuccess)
          .withFailureHandler(onError)
          .refreshPortfolioPrices();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    function onSuccess(result) {
      document.getElementById('status').className = 'status success';
      document.getElementById('status').innerText = result || 'Portfolio formulas refreshed!';
      document.getElementById('yesBtn').style.display = 'none';
      document.getElementById('noBtn').innerText = 'Done';
      document.getElementById('noBtn').disabled = false;
    }

    function onError(err) {
      document.getElementById('status').className = 'status';
      document.getElementById('status').style.display = 'block';
      document.getElementById('status').style.background = '#fce8e6';
      document.getElementById('status').style.color = '#c5221f';
      document.getElementById('status').innerText = 'Error: ' + (err.message || err);
      document.getElementById('yesBtn').disabled = false;
      document.getElementById('noBtn').disabled = false;
    }
  </script>
</body>
</html>
