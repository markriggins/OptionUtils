<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
    h3 { margin: 0 0 16px 0; color: #202124; }
    .description { color: #5f6368; font-size: 13px; margin-bottom: 16px; line-height: 1.5; }
    .section { background: white; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .section h4 { margin: 0 0 8px 0; color: #1a73e8; font-size: 14px; }
    .section p { margin: 0 0 8px 0; color: #5f6368; font-size: 12px; }
    .checkbox-item { display: flex; align-items: flex-start; margin: 8px 0; }
    .checkbox-item input { margin-right: 10px; margin-top: 3px; }
    .checkbox-item label { color: #202124; font-size: 13px; }
    .checkbox-item .details { color: #5f6368; font-size: 11px; margin-top: 2px; }
    .warning { background: #fef7e0; border-left: 4px solid #f9ab00; padding: 12px; margin-bottom: 16px; font-size: 13px; }
    .buttons { margin-top: 20px; text-align: right; }
    .buttons button { padding: 10px 24px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 8px; }
    #cancelBtn { background: white; border: 1px solid #dadce0; color: #5f6368; }
    #cancelBtn:hover { background: #f1f3f4; }
    #initBtn { background: #1a73e8; border: none; color: white; }
    #initBtn:hover { background: #1557b0; }
    .status { margin-top: 12px; padding: 12px; border-radius: 4px; font-size: 13px; display: none; }
    .status.info { background: #e8f0fe; color: #1a73e8; display: block; }
    .status.success { background: #e6f4ea; color: #137333; display: block; }
    .status.error { background: #fce8e6; color: #c5221f; display: block; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #1a73e8; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .no-data { color: #5f6368; font-style: italic; }
  </style>
</head>
<body>
  <h3>Initialize / Clear Project</h3>

  <div id="sheetsWarning" class="warning" style="display:none;">
    <strong>Sheets to delete:</strong>
    <div id="sheetsList"></div>
  </div>

  <div id="dataSection" class="section" style="display:none;">
    <h4>Existing Data Found</h4>
    <p>Select which data to load after initialization:</p>

    <div id="optionPricesCheck" class="checkbox-item" style="display:none;">
      <input type="checkbox" id="loadOptionPrices" checked>
      <div>
        <label for="loadOptionPrices">Load Option Prices</label>
        <div class="details" id="optionPricesDetails"></div>
      </div>
    </div>

    <div id="portfolioCheck" class="checkbox-item" style="display:none;">
      <input type="checkbox" id="loadPortfolio" checked>
      <div>
        <label for="loadPortfolio">Load Portfolio</label>
        <div class="details" id="portfolioDetails"></div>
      </div>
    </div>

    <div id="noDataMsg" class="no-data" style="display:none;">
      No existing data found in DATA folder.
    </div>
  </div>

  <div id="status" class="status"></div>

  <div class="buttons">
    <button id="cancelBtn" onclick="google.script.host.close()">Cancel</button>
    <button id="initBtn" onclick="doInitialize()">Initialize</button>
  </div>

  <script>
    var initData = {};

    function init(data) {
      initData = data;

      // Show sheets to delete
      if (data.sheetsToDelete && data.sheetsToDelete.length > 0) {
        document.getElementById('sheetsWarning').style.display = 'block';
        document.getElementById('sheetsList').innerText = data.sheetsToDelete.map(s => '  â€¢ ' + s).join('\n');
      }

      // Show data section
      var hasData = false;

      if (data.optionPricesCount > 0) {
        hasData = true;
        document.getElementById('optionPricesCheck').style.display = 'flex';
        document.getElementById('optionPricesDetails').innerText = data.optionPricesCount + ' file(s) in OptionPrices folder';
      }

      if (data.portfolioCount > 0) {
        hasData = true;
        document.getElementById('portfolioCheck').style.display = 'flex';
        document.getElementById('portfolioDetails').innerText = data.portfolioCount + ' file(s) in Etrade folder';
      }

      if (hasData) {
        document.getElementById('dataSection').style.display = 'block';
      } else {
        document.getElementById('dataSection').style.display = 'block';
        document.getElementById('noDataMsg').style.display = 'block';
      }
    }

    function showStatus(message, type) {
      var el = document.getElementById('status');
      el.className = 'status ' + type;
      el.innerHTML = message;
    }

    function doInitialize() {
      document.getElementById('initBtn').disabled = true;
      showStatus('<span class="spinner"></span>Initializing...', 'info');

      var loadOptionPrices = document.getElementById('loadOptionPrices').checked && initData.optionPricesCount > 0;
      var loadPortfolio = document.getElementById('loadPortfolio').checked && initData.portfolioCount > 0;

      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onError)
        .completeInitialization(loadOptionPrices, loadPortfolio);
    }

    function onSuccess(result) {
      showStatus(result || 'Project initialized successfully!', 'success');
      document.getElementById('initBtn').innerText = 'Done';
      document.getElementById('initBtn').disabled = false;
      document.getElementById('initBtn').onclick = function() { google.script.host.close(); };
    }

    function onError(err) {
      showStatus('Error: ' + (err.message || err), 'error');
      document.getElementById('initBtn').disabled = false;
    }
  </script>
</body>
</html>
