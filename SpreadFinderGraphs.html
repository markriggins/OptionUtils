<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f3f4; margin: 0; padding: 15px; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .dashboard { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .chart-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); flex: 1 1 480px; min-width: 400px; }

        /* Fix Double Title: Use HTML Header only */
        .chart-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; margin-bottom: 5px; padding-bottom: 5px; }
        .chart-title { font-weight: bold; color: #3c4043; border-bottom: 1px dashed #1a73e8; cursor: help; position: relative; }
        .chart-div { width: 100%; height: 400px; }

        /* CSS INSTANT TOOLTIPS */
        [data-help] { position: relative; }
        [data-help]:hover::after {
          content: attr(data-help);
          position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%);
          background: #333; color: #fff; padding: 8px; border-radius: 4px;
          font-size: 11px; font-weight: normal; width: 180px; z-index: 1000;
          text-align: center; line-height: 1.4; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          white-space: pre-line;
        }
        .chart-title[data-help]:hover::after {
          left: 0; transform: none; width: 220px; text-align: left;
        }

        /* Panel Styling */
        #details-panel { width: 100%; max-width: 1150px; background: #202124; color: #e8eaed; margin: 20px auto 0 auto; padding: 20px; border-radius: 8px; border-left: 6px solid #8bc34a; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-top: 15px; }
        .metric-box { background: #2d2e31; padding: 10px; border-radius: 4px; border-bottom: 2px solid #3c4043; }
        .label { font-size: 10px; color: #9aa0a6; text-transform: uppercase; display: block; margin-bottom: 4px; border-bottom: 1px dashed #5f6368; width: fit-content; }
        .value { font-size: 14px; color: #8bc34a; font-weight: bold; }

        .os-link { color: #8ab4f8; text-decoration: none; font-weight: bold; border: 1px solid #8ab4f8; padding: 6px 12px; border-radius: 4px; }
        .btn-refresh { background: #1a73e8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .toggle-btn { font-size: 11px; cursor: pointer; color: #1a73e8; border: 1px solid #1a73e8; background: none; border-radius: 4px; padding: 2px 6px; }
    </style>
</head>
<body>

<div class="controls">
    <div style="font-weight:bold; color:#5f6368;">Elite Spread Finder v5.8</div>
    <button class="btn-refresh" onclick="refreshData()">Sync & Refresh</button>
</div>

<div class="dashboard">
    <div class="chart-card">
        <div class="chart-header">
            <span class="chart-title" data-help="Controls&#10;• Zoom: click-drag area&#10;• Pan: arrow keys&#10;• Reset: right-click">Delta vs ROI</span>
            <button class="toggle-btn" onclick="toggleChart('chart_delta')">Hide/Show</button>
        </div>
        <div id="chart_delta" class="chart-div"></div>
    </div>

    <div class="chart-card">
        <div class="chart-header">
            <span class="chart-title" data-help="Controls&#10;• Zoom: click-drag area&#10;• Pan: arrow keys&#10;• Reset: right-click">Strike vs <span id="strike-y-label">ROI</span></span>
            <button class="toggle-btn" onclick="toggleStrikeY()">ROI / ExpROI</button>
            <button class="toggle-btn" onclick="toggleChart('chart_strike')">Hide/Show</button>
        </div>
        <div id="chart_strike" class="chart-div"></div>
    </div>
</div>

<div id="details-panel">
    <div id="instruction" style="text-align:center; color:#9aa0a6; padding: 10px;">Select a trade point above. Double-click for OptionStrat.</div>
    <div id="data-content" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #3c4043; padding-bottom:12px;">
            <h3 id="detail-label" style="margin:0; color:#8bc34a;"></h3>
            <a id="det-osurl" href="#" target="_blank" class="os-link">OptionStrat ↗</a>
        </div>

        <div class="grid-container">
            <div class="metric-box" data-help="Strike gap width."><span class="label">Width</span><span id="det-width" class="value"></span></div>
            <div class="metric-box" data-help="Cost to enter."><span class="label">Debit</span><span id="det-debit" class="value"></span></div>
            <div class="metric-box" data-help="Width minus Debit."><span class="label">Max Profit</span><span id="det-maxp" class="value"></span></div>
            <div class="metric-box" data-help="Max profit / debit cost. Higher = more return per dollar risked."><span class="label">ROI</span><span id="det-roi" class="value"></span></div>
            <div class="metric-box" data-help="Probability-weighted ROI using prob-of-touch model."><span class="label">Exp ROI</span><span id="det-eroi" class="value"></span></div>
            <div class="metric-box" data-help="Days to expire."><span class="label">DTE</span><span id="det-dte" class="value"></span></div>
            <div class="metric-box" data-help="Volatility level."><span class="label">IV</span><span id="det-iv" class="value"></span></div>
            <div class="metric-box" data-help="Buy-side Delta."><span class="label">L-Delta</span><span id="det-ld" class="value"></span></div>
            <div class="metric-box" data-help="Sell-side Delta."><span class="label">U-Delta</span><span id="det-ud" class="value"></span></div>
            <div class="metric-box" data-help="Lower Open Interest."><span class="label">L-OI</span><span id="det-loi" class="value"></span></div>
            <div class="metric-box" data-help="Upper Open Interest."><span class="label">U-OI</span><span id="det-uoi" class="value"></span></div>
            <div class="metric-box" data-help="Volume/OI mix."><span class="label">Liquidity</span><span id="det-liq" class="value"></span></div>
            <div class="metric-box" data-help="Bid-ask spread as % of mid price. Lower = easier to fill."><span class="label">Tightness</span><span id="det-tight" class="value"></span></div>
            <div class="metric-box" data-help="ROI × √liquidity × √tightness × √time. Higher = better trade."><span class="label">Fitness</span><span id="det-fit" class="value"></span></div>
        </div>
    </div>
</div>

<script type="text/javascript">
    google.charts.load('current', {'packages':['corechart']});
    var rawData = [], chartD, chartS, dtD, dtS, strikeYMode = 'roi';

    // FIX: title removed here to stop double titles
    var baseOpts = {
      legend: 'none', chartArea: {width: '85%', height: '85%', top: 20},
      vAxis: {title: 'ROI %'}, hAxis: {gridlines: {color: '#f0f0f0'}}
    };

    google.charts.setOnLoadCallback(init);
    function init() { google.script.run.withSuccessHandler(draw).getSidebarData(); }
    function refreshData() { document.getElementById('instruction').innerText = "Processing..."; google.script.run.withSuccessHandler(init).refreshOptionPrices(); }

    // Axis state: tracks current viewWindow for each chart
    var views = { delta: {h: null, v: null}, strike: {h: null, v: null} };
    var defaults = { delta: {h: null, v: null}, strike: {h: null, v: null} };

    function dataRange(dt, col) {
      var min = Infinity, max = -Infinity;
      for (var i = 0; i < dt.getNumberOfRows(); i++) {
        var v = dt.getValue(i, col);
        if (v < min) min = v;
        if (v > max) max = v;
      }
      var pad = (max - min) * 0.05 || 1;
      return { min: min - pad, max: max + pad };
    }

    function makeOpts(key) {
      var o = JSON.parse(JSON.stringify(baseOpts));
      o.hAxis.viewWindow = views[key].h;
      o.vAxis.viewWindow = views[key].v;
      return o;
    }

    function redrawChart(key) {
      if (key === 'delta') chartD.draw(dtD, makeOpts('delta'));
      if (key === 'strike') chartS.draw(dtS, makeOpts('strike'));
    }

    function toggleChart(id) {
      var el = document.getElementById(id);
      el.style.display = (el.style.display === 'none') ? 'block' : 'none';
      if (el.style.display === 'block') {
        var key = id === 'chart_delta' ? 'delta' : 'strike';
        redrawChart(key);
      }
    }

    function pointStyle(r) {
      if (r.held) {
        return 'point { size: 5; fill-color: #9e9e9e; opacity: 0.35; stroke-width: 1; stroke-color: #757575; }';
      }
      var color = r.fitness >= 4.0 ? '#2e7d32' : (r.fitness >= 3.0 ? '#66bb6a' : (r.fitness >= 2.0 ? '#ffeb3b' : '#f44336'));
      return 'point { size: ' + (r.fitness >= 4.0 ? 9 : 4) + '; fill-color: ' + color + '; stroke-width: 1; stroke-color: #333; }';
    }

    function buildStrikeTable(dataArray) {
      dtS = new google.visualization.DataTable();
      var yLabel = strikeYMode === 'roi' ? 'ROI' : 'ExpROI';
      dtS.addColumn('number', 'X'); dtS.addColumn('number', yLabel);
      dtS.addColumn({type: 'string', role: 'tooltip'}); dtS.addColumn({type: 'string', role: 'style'});
      dataArray.forEach(r => {
        var yVal = strikeYMode === 'roi' ? r.roi * 100 : (r.expectedROI || 0) * 100;
        dtS.addRow([r.strike, yVal, r.held ? r.label + ' [HELD]' : r.label, pointStyle(r)]);
      });
    }

    function toggleStrikeY() {
      strikeYMode = strikeYMode === 'roi' ? 'expectedROI' : 'roi';
      document.getElementById('strike-y-label').innerText = strikeYMode === 'roi' ? 'ROI' : 'ExpROI';
      buildStrikeTable(rawData);
      defaults.strike.h = dataRange(dtS, 0); defaults.strike.v = dataRange(dtS, 1);
      views.strike = {h: Object.assign({}, defaults.strike.h), v: Object.assign({}, defaults.strike.v)};
      redrawChart('strike');
    }

    function draw(dataArray) {
      rawData = dataArray;
      if (!dataArray || dataArray.length === 0) return;
      dtD = new google.visualization.DataTable();
      dtD.addColumn('number', 'X'); dtD.addColumn('number', 'ROI');
      dtD.addColumn({type: 'string', role: 'tooltip'}); dtD.addColumn({type: 'string', role: 'style'});

      dataArray.forEach(r => {
        dtD.addRow([r.delta, r.roi * 100, r.held ? r.label + ' [HELD]' : r.label, pointStyle(r)]);
      });
      buildStrikeTable(dataArray);

      // Set default ranges
      defaults.delta.h = dataRange(dtD, 0); defaults.delta.v = dataRange(dtD, 1);
      defaults.strike.h = dataRange(dtS, 0); defaults.strike.v = dataRange(dtS, 1);
      views.delta = {h: Object.assign({}, defaults.delta.h), v: Object.assign({}, defaults.delta.v)};
      views.strike = {h: Object.assign({}, defaults.strike.h), v: Object.assign({}, defaults.strike.v)};

      chartD = new google.visualization.ScatterChart(document.getElementById('chart_delta'));
      chartS = new google.visualization.ScatterChart(document.getElementById('chart_strike'));

      function updateAnalytics(rowIndex) {
        var t = rawData[rowIndex];
        document.getElementById('instruction').style.display = 'none';
        document.getElementById('data-content').style.display = 'block';
        var labelEl = document.getElementById('detail-label');
        labelEl.innerHTML = t.held ? t.label + '  <span data-help="You cannot be long and short on the same option" style="color:#ff9800;cursor:help;">⚠ HELD</span>' : t.label;
        labelEl.style.color = t.held ? '#ff9800' : '#8bc34a';
        document.getElementById('det-osurl').onclick = function() { window.open(t.osUrl, '_blank'); return false; };

        document.getElementById('det-width').innerText = t.width;
        document.getElementById('det-debit').innerText = "$" + Number(t.debit).toFixed(2);
        document.getElementById('det-maxp').innerText = "$" + Number(t.maxProfit).toFixed(2);
        document.getElementById('det-dte').innerText = t.dte + "d";
        document.getElementById('det-iv').innerText = (t.iv * 100).toFixed(1) + "%";
        document.getElementById('det-ld').innerText = t.lowerDelta;
        document.getElementById('det-ud').innerText = t.upperDelta;
        document.getElementById('det-loi').innerText = t.lowerOI;
        document.getElementById('det-uoi').innerText = t.upperOI;
        document.getElementById('det-liq').innerText = t.liquidity;

        var roiVal = t.roi * 100;
        var roiEl = document.getElementById('det-roi');
        roiEl.innerText = roiVal.toFixed(1) + "%";
        roiEl.style.color = roiVal >= 100 ? '#8bc34a' : (roiVal >= 50 ? '#ffeb3b' : '#f44336');

        var eroiVal = (t.expectedROI || 0) * 100;
        var eroiEl = document.getElementById('det-eroi');
        eroiEl.innerText = eroiVal.toFixed(1) + "%";
        eroiEl.style.color = eroiVal >= 100 ? '#8bc34a' : (eroiVal >= 50 ? '#ffeb3b' : '#f44336');

        var tightEl = document.getElementById('det-tight');
        tightEl.innerText = t.tightness;
        tightEl.style.color = t.tightness <= 0.5 ? '#8bc34a' : (t.tightness <= 1.5 ? '#ffeb3b' : '#f44336');

        var fitEl = document.getElementById('det-fit');
        fitEl.innerText = t.fitness;
        fitEl.style.color = t.fitness >= 4.0 ? '#8bc34a' : (t.fitness >= 3.0 ? '#66bb6a' : (t.fitness >= 2.0 ? '#ffeb3b' : '#f44336'));
      }

      [chartD, chartS].forEach(c => {
        google.visualization.events.addListener(c, 'select', function() {
          var sel = c.getSelection();
          if (sel.length > 0) updateAnalytics(sel[0].row);
        });
      });

      [document.getElementById('chart_delta'), document.getElementById('chart_strike')].forEach((el, idx) => {
        el.addEventListener('dblclick', function() {
          var c = idx === 0 ? chartD : chartS;
          var sel = c.getSelection();
          if (sel.length > 0) window.open(rawData[sel[0].row].osUrl, '_blank');
        });
      });

      // Drag-to-zoom on chart divs
      ['chart_delta', 'chart_strike'].forEach(function(id) {
        var el = document.getElementById(id);
        var key = id === 'chart_delta' ? 'delta' : 'strike';
        var chart = key === 'delta' ? chartD : chartS;
        var dragStart = null;
        el.style.position = 'relative';

        // Selection box
        var selBox = document.createElement('div');
        selBox.style.cssText = 'position:absolute;border:2px dashed #1a73e8;background:rgba(26,115,232,0.1);display:none;z-index:11;pointer-events:none;';
        el.appendChild(selBox);

        el.addEventListener('mousedown', function(e) {
          if (e.button !== 0 || e.shiftKey) return; // only left click, not shift (leave shift for select)
          // Check if click is in chart area (not on a point)
          var cli = chart.getChartLayoutInterface();
          var rect = el.getBoundingClientRect();
          var x = e.clientX - rect.left, y = e.clientY - rect.top;
          var ca = cli.getChartAreaBoundingBox();
          if (x < ca.left || x > ca.left + ca.width || y < ca.top || y > ca.top + ca.height) return;
          dragStart = {x: x, y: y, clientX: e.clientX, clientY: e.clientY};
          selBox.style.display = 'block';
          selBox.style.left = x + 'px'; selBox.style.top = y + 'px';
          selBox.style.width = '0'; selBox.style.height = '0';
          e.preventDefault();
        });

        el.addEventListener('mousemove', function(e) {
          if (!dragStart) return;
          var rect = el.getBoundingClientRect();
          var x = e.clientX - rect.left, y = e.clientY - rect.top;
          var sx = Math.min(dragStart.x, x), sy = Math.min(dragStart.y, y);
          var sw = Math.abs(x - dragStart.x), sh = Math.abs(y - dragStart.y);
          selBox.style.left = sx + 'px'; selBox.style.top = sy + 'px';
          selBox.style.width = sw + 'px'; selBox.style.height = sh + 'px';
          e.preventDefault();
        });

        el.addEventListener('mouseup', function(e) {
          if (!dragStart) return;
          selBox.style.display = 'none';
          var rect = el.getBoundingClientRect();
          var x2 = e.clientX - rect.left, y2 = e.clientY - rect.top;
          var sx = Math.min(dragStart.x, x2), ex = Math.max(dragStart.x, x2);
          var sy = Math.min(dragStart.y, y2), ey = Math.max(dragStart.y, y2);
          var dx = ex - sx, dy = ey - sy;
          dragStart = null;

          if (dx < 10 && dy < 10) return;

          var cli = chart.getChartLayoutInterface();
          var hMin = cli.getHAxisValue(sx), hMax = cli.getHAxisValue(ex);
          var vMax = cli.getVAxisValue(sy), vMin = cli.getVAxisValue(ey);

          if (hMin != null && hMax != null) views[key].h = {min: hMin, max: hMax};
          if (vMin != null && vMax != null) views[key].v = {min: vMin, max: vMax};
          redrawChart(key);
          e.preventDefault();
        });
      });

      redrawChart('delta');
      redrawChart('strike');

      // Arrow keys pan, right-click resets
      document.addEventListener('keydown', function(e) {
        var dominated = ['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'];
        if (dominated.indexOf(e.key) === -1) return;
        var horiz = (e.key === 'ArrowLeft' || e.key === 'ArrowRight');
        var dir = (e.key === 'ArrowRight' || e.key === 'ArrowUp') ? 1 : -1;
        ['delta', 'strike'].forEach(function(key) {
          if (horiz) {
            var h = views[key].h;
            var shift = (h.max - h.min) * 0.15 * dir;
            views[key].h = {min: h.min + shift, max: h.max + shift};
          } else {
            var v = views[key].v;
            var shift = (v.max - v.min) * 0.15 * dir;
            views[key].v = {min: v.min + shift, max: v.max + shift};
          }
        });
        redrawChart('delta');
        redrawChart('strike');
        e.preventDefault();
      });

      // Right-click to reset zoom
      ['chart_delta', 'chart_strike'].forEach(function(id) {
        var key = id === 'chart_delta' ? 'delta' : 'strike';
        document.getElementById(id).addEventListener('contextmenu', function(e) {
          views[key].h = Object.assign({}, defaults[key].h);
          views[key].v = Object.assign({}, defaults[key].v);
          redrawChart(key);
          e.preventDefault();
        });
      });
    }
</script>
</body>
</html>