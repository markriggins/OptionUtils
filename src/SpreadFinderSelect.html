<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    h3 { margin-top: 0; margin-bottom: 8px; }
    .section { margin-bottom: 16px; }
    .section-label { font-weight: bold; margin-bottom: 8px; color: #333; }
    .options { max-height: 180px; overflow-y: auto; border: 1px solid #dadce0; border-radius: 4px; padding: 4px; }
    .options label { display: block; padding: 6px 10px; cursor: pointer; border-radius: 4px; }
    .options label:hover { background: #f1f3f4; }
    .options input[type=checkbox] { margin-right: 8px; }
    .select-all { font-size: 12px; color: #1a73e8; cursor: pointer; margin-left: 8px; }
    .select-all:hover { text-decoration: underline; }
    .buttons { margin-top: 16px; text-align: right; }
    .buttons button { margin-left: 8px; padding: 8px 20px; border-radius: 4px; cursor: pointer; }
    #okBtn { background: #1a73e8; color: white; border: none; }
    #okBtn:hover { background: #1557b0; }
    #okBtn:disabled { background: #ccc; }
    #cancelBtn { background: white; border: 1px solid #dadce0; }
    #cancelBtn:hover { background: #f1f3f4; }
    #loading { color: #666; }
    .count { font-size: 12px; color: #666; margin-left: 4px; }
  </style>
</head>
<body>
  <h3>Run SpreadFinder</h3>
  <div id="loading">Loading available options...</div>
  <div id="content" style="display:none">
    <div class="section">
      <div class="section-label">
        Symbol
        <span class="select-all" onclick="toggleAll('symbols')">select all</span>
      </div>
      <div class="options" id="symbols"></div>
    </div>
    <div class="section">
      <div class="section-label">
        Expirations
        <span class="select-all" onclick="toggleAll('expirations')">select all</span>
        <span class="count" id="expCount"></span>
      </div>
      <div class="options" id="expirations"></div>
    </div>
    <div class="buttons">
      <button id="cancelBtn">Cancel</button>
      <button id="okBtn">Run SpreadFinder</button>
    </div>
  </div>

  <script>
    var allData = { symbols: [], expirations: [] };

    function populate(data) {
      allData = data;

      // Populate symbols
      var symContainer = document.getElementById('symbols');
      data.symbols.forEach(function(sym, idx) {
        var label = document.createElement('label');
        var cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.name = 'symbol';
        cb.value = sym;
        if (idx === 0) cb.checked = true; // Select first by default
        label.appendChild(cb);
        label.appendChild(document.createTextNode(sym));
        symContainer.appendChild(label);
      });

      // Populate expirations (sorted by date)
      var expContainer = document.getElementById('expirations');
      data.expirations.forEach(function(exp, idx) {
        var label = document.createElement('label');
        var cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.name = 'expiration';
        cb.value = exp.value;
        cb.checked = true; // Select all expirations by default
        label.appendChild(cb);
        label.appendChild(document.createTextNode(exp.label));
        expContainer.appendChild(label);
      });

      document.getElementById('expCount').textContent = '(' + data.expirations.length + ')';
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = '';
    }

    function toggleAll(containerId) {
      var checkboxes = document.querySelectorAll('#' + containerId + ' input[type=checkbox]');
      var allChecked = Array.from(checkboxes).every(function(cb) { return cb.checked; });
      checkboxes.forEach(function(cb) { cb.checked = !allChecked; });
    }

    function getSelected(name) {
      var checkboxes = document.querySelectorAll('input[name=' + name + ']:checked');
      return Array.from(checkboxes).map(function(cb) { return cb.value; });
    }

    document.getElementById('okBtn').addEventListener('click', function() {
      var symbols = getSelected('symbol');
      var expirations = getSelected('expiration');

      if (symbols.length === 0) {
        alert('Select at least one symbol.');
        return;
      }
      if (expirations.length === 0) {
        alert('Select at least one expiration.');
        return;
      }

      document.getElementById('okBtn').disabled = true;
      document.getElementById('okBtn').textContent = 'Running...';

      google.script.run
        .withSuccessHandler(function() { google.script.host.close(); })
        .withFailureHandler(function(err) {
          alert('Error: ' + (err.message || err));
          document.getElementById('okBtn').disabled = false;
          document.getElementById('okBtn').textContent = 'Run SpreadFinder';
        })
        .runSpreadFinderWithSelection(symbols, expirations);
    });

    document.getElementById('cancelBtn').addEventListener('click', function() {
      google.script.host.close();
    });

    // Load data on open
    google.script.run
      .withSuccessHandler(populate)
      .withFailureHandler(function(err) {
        document.getElementById('loading').textContent = 'Error: ' + (err.message || err);
      })
      .getSpreadFinderOptions();
  </script>
</body>
</html>
