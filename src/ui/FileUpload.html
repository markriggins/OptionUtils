<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
    h3 { margin: 0 0 16px 0; color: #202124; }
    .description { color: #5f6368; font-size: 13px; margin-bottom: 16px; line-height: 1.5; }
    .file-section { background: white; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .file-section h4 { margin: 0 0 8px 0; color: #1a73e8; font-size: 14px; }
    .file-section p { margin: 0 0 12px 0; color: #5f6368; font-size: 12px; }
    .file-input-wrapper { position: relative; }
    input[type="file"] { width: 100%; padding: 8px; border: 2px dashed #dadce0; border-radius: 4px; background: #f8f9fa; cursor: pointer; }
    input[type="file"]:hover { border-color: #1a73e8; background: #e8f0fe; }
    .file-name { margin-top: 8px; font-size: 12px; color: #1a73e8; }
    .buttons { margin-top: 20px; text-align: right; }
    .buttons button { padding: 10px 24px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 8px; }
    #cancelBtn { background: white; border: 1px solid #dadce0; color: #5f6368; }
    #cancelBtn:hover { background: #f1f3f4; }
    #uploadBtn { background: #1a73e8; border: none; color: white; }
    #uploadBtn:hover { background: #1557b0; }
    #uploadBtn:disabled { background: #dadce0; cursor: not-allowed; }
    .status { margin-top: 12px; padding: 12px; border-radius: 4px; font-size: 13px; display: none; }
    .status.info { background: #e8f0fe; color: #1a73e8; display: block; }
    .status.success { background: #e6f4ea; color: #137333; display: block; }
    .status.error { background: #fce8e6; color: #c5221f; display: block; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #1a73e8; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h3 id="dialogTitle">Upload Files</h3>
  <div class="description" id="dialogDescription"></div>

  <div id="optionPricesSection" class="file-section" style="display:none;">
    <h4>Option Prices CSV</h4>
    <p>Download from barchart.com: Options > Select expiration > Stacked view > Download CSV</p>
    <input type="file" id="optionPricesFile" accept=".csv" multiple>
    <div class="file-name" id="optionPricesName"></div>
    <div id="uploadModeRadios" class="upload-mode" style="margin-top: 12px; display: none;">
      <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #202124;">
        <input type="radio" name="uploadMode" value="merge" checked>
        <strong>Merge new</strong> — Only update if uploaded data is newer
      </label>
      <label style="display: block; font-size: 13px; color: #202124;">
        <input type="radio" name="uploadMode" value="replace">
        <strong>Replace all</strong> — Clear existing prices first
      </label>
    </div>
  </div>

  <div id="updateModeSection" class="file-section" style="display:none;">
    <div class="upload-mode" style="margin-bottom: 12px;">
      <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #202124;">
        <input type="radio" name="updateMode" value="addTransactions" checked>
        <strong>Add transactions</strong> — Append new transactions to existing portfolio
      </label>
      <label style="display: block; font-size: 13px; color: #202124;">
        <input type="radio" name="updateMode" value="rebuild">
        <strong>Clear and rebuild</strong> — Delete portfolio, rebuild from scratch
      </label>
    </div>
  </div>

  <div id="portfolioSection" class="file-section" style="display:none;">
    <h4>Portfolio Download CSV</h4>
    <p>From E*Trade: Accounts > Portfolio > View "All Positions" > Download</p>
    <input type="file" id="portfolioFile" accept=".csv">
    <div class="file-name" id="portfolioName"></div>
  </div>

  <div id="transactionsSection" class="file-section" style="display:none;">
    <h4>Transaction History CSV</h4>
    <p>From E*Trade: Accounts > Transactions > Download (select CSV format)</p>
    <input type="file" id="transactionsFile" accept=".csv" multiple>
    <div class="file-name" id="transactionsName"></div>
  </div>

  <div id="status" class="status"></div>

  <div class="buttons">
    <button id="cancelBtn" onclick="google.script.host.close()">Cancel</button>
    <button id="uploadBtn" onclick="uploadFiles()" disabled>Upload & Process</button>
  </div>

  <script>
    var uploadMode = '';
    var filesToUpload = {};

    function init(mode) {
      uploadMode = mode;

      if (mode === 'optionPrices') {
        document.getElementById('dialogTitle').innerText = 'Upload Option Prices';
        document.getElementById('dialogDescription').innerText = 'Select option price CSV files from barchart.com. For each expiration date, the uploaded data replaces any previous prices for that expiration.';
        document.getElementById('optionPricesSection').style.display = 'block';

        // Check if existing prices exist to show merge/replace options
        google.script.run
          .withSuccessHandler(function(hasExisting) {
            if (hasExisting) {
              document.getElementById('uploadModeRadios').style.display = 'block';
            }
          })
          .hasExistingOptionPrices();
      } else if (mode === 'rebuildPortfolio') {
        document.getElementById('dialogTitle').innerText = 'Upload Portfolio / Transactions';
        document.getElementById('dialogDescription').innerText = 'Upload E*Trade files to build your portfolio.';
        document.getElementById('transactionsSection').style.display = 'block';
        document.getElementById('portfolioSection').style.display = 'block';

        // Check if existing portfolio exists to show add/rebuild options
        google.script.run
          .withSuccessHandler(function(hasExisting) {
            if (hasExisting) {
              document.getElementById('dialogDescription').innerText = 'Upload E*Trade files to update your portfolio. Choose whether to add transactions or fully rebuild.';
              document.getElementById('updateModeSection').style.display = 'block';
              // Hide portfolio section when add transactions is selected
              document.getElementById('portfolioSection').style.display = 'none';

              // Toggle portfolio section based on mode selection
              document.querySelectorAll('input[name="updateMode"]').forEach(function(radio) {
                radio.addEventListener('change', function() {
                  var isRebuild = document.querySelector('input[name="updateMode"]:checked').value === 'rebuild';
                  document.getElementById('portfolioSection').style.display = isRebuild ? 'block' : 'none';
                  updateUploadButton();
                });
              });
            }
            // If no existing portfolio, leave portfolio section visible (default)
          })
          .withFailureHandler(function() {
            // On error, leave defaults (portfolio section visible)
          })
          .hasExistingPortfolio();
      }
    }

    // File input handlers
    document.getElementById('optionPricesFile').addEventListener('change', function(e) {
      var files = e.target.files;
      if (files.length > 0) {
        // Filter for files with "options" in the name
        var validFiles = Array.from(files).filter(f => f.name.toLowerCase().includes('options'));
        var skipped = files.length - validFiles.length;

        if (validFiles.length > 0) {
          var names = validFiles.map(f => '• ' + f.name).join('<br>');
          var msg = names;
          if (skipped > 0) {
            msg += '<br><em>(skipped ' + skipped + ' file(s) without "options" in name)</em>';
          }
          document.getElementById('optionPricesName').innerHTML = msg;
          filesToUpload.optionPrices = validFiles;
        } else {
          document.getElementById('optionPricesName').innerText = 'No files with "options" in filename. Expected format: symbol-options-exp-YYYY-MM-DD-....csv';
          filesToUpload.optionPrices = null;
        }
      }
      updateUploadButton();
    });

    document.getElementById('portfolioFile').addEventListener('change', function(e) {
      var file = e.target.files[0];
      if (file) {
        var name = file.name.toLowerCase();
        var msg = file.name;
        // Warn if filename doesn't look like a portfolio file
        if (!name.includes('portfolio') && !name.includes('position')) {
          if (name.includes('txn') || name.includes('transaction')) {
            msg += '<br><em style="color:#c5221f;">This looks like a Transaction file. Use the Transaction chooser below.</em>';
          } else if (name.includes('option')) {
            msg += '<br><em style="color:#c5221f;">This looks like an Option Prices file. Use OptionTools > SpreadFinder > Upload Option Prices.</em>';
          }
        }
        document.getElementById('portfolioName').innerHTML = msg;
        filesToUpload.portfolio = file;
      }
      updateUploadButton();
    });

    document.getElementById('transactionsFile').addEventListener('change', function(e) {
      var files = e.target.files;
      if (files.length > 0) {
        var warnings = [];
        var validFiles = [];
        Array.from(files).forEach(function(f) {
          var name = f.name.toLowerCase();
          if (name.includes('portfolio') || name.includes('position')) {
            warnings.push('• ' + f.name + ' <em style="color:#c5221f;">(looks like Portfolio file)</em>');
          } else if (name.includes('option') && name.includes('exp-')) {
            warnings.push('• ' + f.name + ' <em style="color:#c5221f;">(looks like Option Prices file)</em>');
          } else {
            validFiles.push(f);
          }
        });
        var names = validFiles.map(function(f) { return '• ' + f.name; }).join('<br>');
        if (warnings.length > 0) {
          names += '<br>' + warnings.join('<br>');
        }
        document.getElementById('transactionsName').innerHTML = names;
        filesToUpload.transactions = files; // Still allow all files, just warn
      }
      updateUploadButton();
    });

    function updateUploadButton() {
      var hasFiles = false;
      if (uploadMode === 'optionPrices') {
        hasFiles = filesToUpload.optionPrices && filesToUpload.optionPrices.length > 0;
      } else if (uploadMode === 'rebuildPortfolio') {
        var updateMode = document.querySelector('input[name="updateMode"]:checked').value;
        var hasTransactions = filesToUpload.transactions && filesToUpload.transactions.length > 0;
        if (updateMode === 'addTransactions') {
          // Add transactions mode: only transactions required
          hasFiles = hasTransactions;
        } else {
          // Rebuild mode: need at least one file
          var hasPortfolio = !!filesToUpload.portfolio;
          hasFiles = hasPortfolio || hasTransactions;
        }
      }
      document.getElementById('uploadBtn').disabled = !hasFiles;
    }

    function showStatus(message, type) {
      var el = document.getElementById('status');
      el.className = 'status ' + type;
      el.innerHTML = message;
    }

    function readFileAsText(file) {
      return new Promise(function(resolve, reject) {
        var reader = new FileReader();
        reader.onload = function(e) { resolve({ name: file.name, content: e.target.result }); };
        reader.onerror = function(e) { reject(e); };
        reader.readAsText(file);
      });
    }

    async function uploadFiles(confirmed) {
      document.getElementById('uploadBtn').disabled = true;
      showStatus('<span class="spinner"></span>Uploading and processing files...', 'info');

      try {
        if (uploadMode === 'optionPrices') {
          var files = await Promise.all(Array.from(filesToUpload.optionPrices).map(readFileAsText));
          var replaceAll = document.querySelector('input[name="uploadMode"]:checked').value === 'replace';
          google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(onError)
            .uploadOptionPrices(files, replaceAll, !!confirmed);
        } else if (uploadMode === 'rebuildPortfolio') {
          var updateMode = document.querySelector('input[name="updateMode"]:checked').value;
          var portfolio = filesToUpload.portfolio ? await readFileAsText(filesToUpload.portfolio) : null;
          var transactions = filesToUpload.transactions ? await Promise.all(Array.from(filesToUpload.transactions).map(readFileAsText)) : [];
          google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(onError)
            .uploadAndRebuildPortfolio(portfolio, transactions, updateMode);
        }
      } catch (e) {
        onError(e);
      }
    }

    function onSuccess(result) {
      // Handle confirmation request for replace-all with orphaned expirations
      if (result && result.needsConfirmation) {
        var msg = result.message + '\n\nContinue anyway?';
        if (confirm(msg)) {
          uploadFiles(true);  // Re-call with confirmed=true
        } else {
          showStatus('Upload cancelled.', 'info');
          document.getElementById('uploadBtn').disabled = false;
        }
        return;
      }

      showStatus(result || 'Files uploaded and processed successfully!', 'success');
      document.getElementById('uploadBtn').innerText = 'Done';
      document.getElementById('uploadBtn').disabled = false;
      document.getElementById('uploadBtn').onclick = function() { google.script.host.close(); };
    }

    function onError(err) {
      showStatus('Error: ' + (err.message || err), 'error');
      document.getElementById('uploadBtn').disabled = false;
    }

    // Get mode from URL parameter or call init directly
    var params = new URLSearchParams(window.location.search);
    var mode = params.get('mode');
    if (mode) init(mode);
  </script>
</body>
</html>
