<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f3f4; margin: 0; padding: 15px; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .dashboard { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .chart-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); flex: 1 1 480px; min-width: 400px; }

        /* Fix Double Title: Use HTML Header only */
        .chart-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; margin-bottom: 5px; padding-bottom: 5px; }
        .chart-title { font-weight: bold; color: #3c4043; border-bottom: 1px dashed #1a73e8; cursor: help; position: relative; }
        .chart-div { width: 100%; height: 400px; position: relative; }
        .chart-spinner {
          position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
          display: flex; flex-direction: column; align-items: center; gap: 10px; color: #5f6368;
        }
        .chart-spinner .dot-pulse { display: inline-flex; gap: 6px; }
        .chart-spinner .dot-pulse span {
          width: 10px; height: 10px; border-radius: 50%; background: #1a73e8;
          animation: pulse 1.2s ease-in-out infinite;
        }
        .chart-spinner .dot-pulse span:nth-child(2) { animation-delay: 0.2s; }
        .chart-spinner .dot-pulse span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse { 0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); } 40% { opacity: 1; transform: scale(1.2); } }

        /* CSS INSTANT TOOLTIPS */
        [data-help] { position: relative; }
        [data-help]:hover::after {
          content: attr(data-help);
          position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%);
          background: #333; color: #fff; padding: 8px; border-radius: 4px;
          font-size: 11px; font-weight: normal; width: 180px; z-index: 1000;
          text-align: center; line-height: 1.4; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          white-space: pre-line;
        }
        .chart-title[data-help]:hover::after {
          left: 0; transform: none; width: 220px; text-align: left;
        }

        /* Panel Styling */
        #details-panel { width: 100%; max-width: 1150px; background: #202124; color: #e8eaed; margin: 20px auto 0 auto; padding: 20px; border-radius: 8px; border-left: 6px solid #8bc34a; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-top: 15px; }
        .metric-box { background: #2d2e31; padding: 10px; border-radius: 4px; border-bottom: 2px solid #3c4043; }
        .label { font-size: 10px; color: #9aa0a6; text-transform: uppercase; display: block; margin-bottom: 4px; border-bottom: 1px dashed #5f6368; width: fit-content; }
        .value { font-size: 14px; color: #8bc34a; font-weight: bold; }

        .os-link { color: #8ab4f8; text-decoration: none; font-weight: bold; border: 1px solid #8ab4f8; padding: 6px 12px; border-radius: 4px; }
        .btn-refresh { background: #1a73e8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-help { background: none; color: #5f6368; border: 1px solid #dadce0; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 10px; }
        .btn-help:hover { background: #f1f3f4; }
        .toggle-btn { font-size: 11px; cursor: pointer; color: #1a73e8; border: 1px solid #1a73e8; background: none; border-radius: 4px; padding: 2px 6px; }

        /* Help Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #e0e0e0; }
        .modal-header h2 { margin: 0; color: #202124; font-size: 20px; }
        .modal-close { background: none; border: none; font-size: 24px; color: #5f6368; cursor: pointer; padding: 0; line-height: 1; }
        .modal-close:hover { color: #202124; }
        .modal-body { padding: 24px; color: #3c4043; line-height: 1.6; }
        .modal-body h3 { color: #202124; margin: 20px 0 10px 0; font-size: 16px; }
        .modal-body h3:first-child { margin-top: 0; }
        .modal-body ul { margin: 10px 0; padding-left: 24px; }
        .modal-body li { margin: 8px 0; }
        .color-sample { display: inline-block; width: 14px; height: 14px; border-radius: 50%; vertical-align: middle; margin-right: 6px; border: 1px solid #333; }
        .color-green { background: #2e7d32; }
        .color-light-green { background: #66bb6a; }
        .color-yellow { background: #ffeb3b; }
        .color-red { background: #f44336; }
        .color-gray { background: #9e9e9e; }
        .kbd { background: #f1f3f4; border: 1px solid #dadce0; border-radius: 4px; padding: 2px 6px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>

<div class="controls">
    <div style="font-weight:bold; color:#5f6368;">SpreadFinder</div>
    <div>
        <button class="btn-help" onclick="showHelp()">Help</button>
        <button class="btn-refresh" onclick="refreshData()">Sync & Refresh</button>
    </div>
</div>

<!-- Help Modal -->
<div id="help-modal" class="modal-overlay" onclick="hideHelp(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>How to Use SpreadFinder</h2>
            <button class="modal-close" onclick="hideHelp()">&times;</button>
        </div>
        <div class="modal-body">
            <h3>Understanding the Charts</h3>
            <p>Each bubble represents a potential <strong>bull call spread</strong> you could purchase. The bubbles are color-coded by fitness score percentile to help you quickly identify the best opportunities:</p>
            <ul>
                <li><span class="color-sample color-green"></span><strong>Dark Green (large)</strong> — Top 10% — Best opportunities with favorable liquidity and tight bid/ask spreads</li>
                <li><span class="color-sample color-light-green"></span><strong>Light Green</strong> — Top 10–40% — Good opportunities</li>
                <li><span class="color-sample color-yellow"></span><strong>Yellow</strong> — Top 40–75% — Moderate opportunities</li>
                <li><span class="color-sample color-red"></span><strong>Red</strong> — Bottom 25% — Lower quality (poor liquidity or wide spreads)</li>
                <li><span class="color-sample color-gray"></span><strong>Gray</strong> — Conflicts with existing holdings in your portfolio (you cannot be long and short the same option)</li>
            </ul>

            <h3>Selecting a Spread</h3>
            <p><strong>Click</strong> any bubble to see its details in the panel below, including strike prices, debit cost, ROI, expected ROI, and liquidity metrics.</p>
            <p><strong>Double-click</strong> a bubble to open it in <strong>OptionStrat</strong> for visual profit/loss analysis.</p>

            <h3>Chart Controls</h3>
            <ul>
                <li><strong>Zoom:</strong> Click and drag to select an area to zoom into</li>
                <li><strong>Pan:</strong> Use <span class="kbd">←</span> <span class="kbd">→</span> <span class="kbd">↑</span> <span class="kbd">↓</span> arrow keys</li>
                <li><strong>Reset:</strong> Right-click to reset zoom to default view</li>
            </ul>

            <h3>Key Metrics</h3>
            <ul>
                <li><strong>ROI</strong> — Maximum return if stock closes above upper strike at expiration</li>
                <li><strong>Expected ROI</strong> — Probability-weighted ROI based on the chance the stock reaches the upper strike. Accounts for both: (1) expiring fully in-the-money at max profit, or (2) price touching the upper strike earlier, allowing you to exit early yet still capture ~80% of gains</li>
                <li><strong>Fitness</strong> — Rewards higher expected ROI, liquidity, and outlook alignment</li>
            </ul>
        </div>
    </div>
</div>

<div class="dashboard">
    <div class="chart-card">
        <div class="chart-header">
            <span class="chart-title" data-help="Controls&#10;• Zoom: click-drag area&#10;• Pan: arrow keys&#10;• Reset: right-click">Strike vs <span id="strike-y-label">ExpROI</span></span>
            <button class="toggle-btn" onclick="toggleStrikeY()">ROI / ExpROI</button>
            <button class="toggle-btn" onclick="toggleChart('chart_strike')">Hide/Show</button>
        </div>
        <div id="chart_strike" class="chart-div"><div class="chart-spinner"><div class="dot-pulse"><span></span><span></span><span></span></div><div>Loading charts...</div></div></div>
    </div>

    <div class="chart-card">
        <div class="chart-header">
            <span class="chart-title" data-help="Controls&#10;• Zoom: click-drag area&#10;• Pan: arrow keys&#10;• Reset: right-click">Delta vs ROI</span>
            <button class="toggle-btn" onclick="toggleChart('chart_delta')">Hide/Show</button>
        </div>
        <div id="chart_delta" class="chart-div"><div class="chart-spinner"><div class="dot-pulse"><span></span><span></span><span></span></div><div>Loading charts...</div></div></div>
    </div>
</div>

<div id="details-panel">
    <div id="instruction" style="text-align:center; color:#9aa0a6; padding: 10px;">Select a trade point above. Double-click for OptionStrat.</div>
    <div id="data-content" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #3c4043; padding-bottom:12px;">
            <h3 id="detail-label" style="margin:0; color:#8bc34a;"></h3>
            <a id="det-osurl" href="#" target="_blank" class="os-link">OptionStrat ↗</a>
        </div>

        <div class="grid-container">
            <div class="metric-box" data-help="Strike gap width."><span class="label">Width</span><span id="det-width" class="value"></span></div>
            <div class="metric-box" data-help="Cost to enter."><span class="label">Debit</span><span id="det-debit" class="value"></span></div>
            <div class="metric-box" data-help="Width minus Debit."><span class="label">Max Profit</span><span id="det-maxp" class="value"></span></div>
            <div class="metric-box" data-help="Max profit / debit cost. Higher = more return per dollar risked."><span class="label">ROI</span><span id="det-roi" class="value"></span></div>
            <div class="metric-box" data-help="Expected ROI based on the probability that the stock price will reach the upper strike before expiration. This accounts for: (1) the chance the spread expires fully in-the-money at max profit, or (2) the price touches the upper strike earlier, allowing you to exit early yet still capture ~80% of gains. Higher = better risk-adjusted return."><span class="label">Exp ROI</span><span id="det-eroi" class="value"></span></div>
            <div class="metric-box" data-help="Days to expire."><span class="label">DTE</span><span id="det-dte" class="value"></span></div>
            <div class="metric-box" data-help="Implied volatility of the lower (long) leg."><span class="label">IV</span><span id="det-iv" class="value"></span></div>
            <div class="metric-box" data-help="Buy-side Delta."><span class="label">L-Delta</span><span id="det-ld" class="value"></span></div>
            <div class="metric-box" data-help="Sell-side Delta."><span class="label">U-Delta</span><span id="det-ud" class="value"></span></div>
            <div class="metric-box" data-help="Lower Open Interest."><span class="label">L-OI</span><span id="det-loi" class="value"></span></div>
            <div class="metric-box" data-help="Upper Open Interest."><span class="label">U-OI</span><span id="det-uoi" class="value"></span></div>
            <div class="metric-box" data-help="0-1 composite: 60% bid-ask spread, 25% volume, 15% open interest"><span class="label">Liquidity</span><span id="det-liq" class="value"></span></div>
            <div class="metric-box" data-help="Rewards higher expected ROI, liquidity, and outlook alignment."><span class="label">Fitness</span><span id="det-fit" class="value"></span></div>
        </div>
    </div>
</div>

<script type="text/javascript">
    // Help modal functions
    function showHelp() {
        document.getElementById('help-modal').classList.add('show');
    }
    function hideHelp(event) {
        if (!event || event.target === document.getElementById('help-modal')) {
            document.getElementById('help-modal').classList.remove('show');
        }
    }
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') hideHelp();
    });

    google.charts.load('current', {'packages':['corechart']});
    var rawData = [], chartD, chartS, dtD, dtS, strikeYMode = 'expectedROI';
    var fitnessPercentiles = { p90: 4, p60: 3, p25: 2 }; // Default thresholds, recalculated from data

    // FIX: title removed here to stop double titles
    var baseOpts = {
      legend: 'none', chartArea: {width: '85%', height: '85%', top: 20},
      vAxis: {title: 'ROI %'}, hAxis: {gridlines: {color: '#f0f0f0'}}
    };

    google.charts.setOnLoadCallback(init);
    function init() { google.script.run.withSuccessHandler(draw).getSpreadFinderGraphData(); }
    function refreshData() { document.getElementById('instruction').innerText = "Processing..."; google.script.run.withSuccessHandler(init).refreshOptionPrices(); }

    // Axis state: tracks current viewWindow for each chart
    var views = { delta: {h: null, v: null}, strike: {h: null, v: null} };
    var defaults = { delta: {h: null, v: null}, strike: {h: null, v: null} };
    var activeKey = 'delta';

    function dataRange(dt, col) {
      var min = Infinity, max = -Infinity;
      for (var i = 0; i < dt.getNumberOfRows(); i++) {
        var v = dt.getValue(i, col);
        if (v < min) min = v;
        if (v > max) max = v;
      }
      var pad = (max - min) * 0.05 || 1;
      return { min: min - pad, max: max + pad };
    }

    function makeOpts(key) {
      var o = JSON.parse(JSON.stringify(baseOpts));
      o.hAxis.viewWindow = views[key].h;
      o.vAxis.viewWindow = views[key].v;
      return o;
    }

    function redrawChart(key) {
      if (key === 'delta') chartD.draw(dtD, makeOpts('delta'));
      if (key === 'strike') chartS.draw(dtS, makeOpts('strike'));
    }

    function toggleChart(id) {
      var el = document.getElementById(id);
      el.style.display = (el.style.display === 'none') ? 'block' : 'none';
      if (el.style.display === 'block') {
        var key = id === 'chart_delta' ? 'delta' : 'strike';
        redrawChart(key);
      }
    }

    function pointStyle(r) {
      if (r.held) {
        return 'point { size: 5; fill-color: #9e9e9e; opacity: 0.35; stroke-width: 1; stroke-color: #757575; }';
      }
      // Use percentile-based thresholds: top 10% = dark green large, next 30% = light green, next 35% = yellow, bottom 25% = red
      var f = r.fitness;
      var color, size;
      if (f >= fitnessPercentiles.p90) {
        color = '#2e7d32'; size = 9; // Dark green, large - top 10%
      } else if (f >= fitnessPercentiles.p60) {
        color = '#66bb6a'; size = 5; // Light green - next 30%
      } else if (f >= fitnessPercentiles.p25) {
        color = '#ffeb3b'; size = 4; // Yellow - next 35%
      } else {
        color = '#f44336'; size = 4; // Red - bottom 25%
      }
      return 'point { size: ' + size + '; fill-color: ' + color + '; stroke-width: 1; stroke-color: #333; }';
    }

    function buildStrikeTable(dataArray) {
      dtS = new google.visualization.DataTable();
      var yLabel = strikeYMode === 'roi' ? 'ROI' : 'ExpROI';
      dtS.addColumn('number', 'X'); dtS.addColumn('number', yLabel);
      dtS.addColumn({type: 'string', role: 'tooltip'}); dtS.addColumn({type: 'string', role: 'style'});
      dataArray.forEach(r => {
        var yVal = strikeYMode === 'roi' ? r.roi * 100 : (r.expectedROI || 0) * 100;
        dtS.addRow([r.strike, yVal, r.held ? r.label + ' [HELD]' : r.label, pointStyle(r)]);
      });
    }

    function toggleStrikeY() {
      strikeYMode = strikeYMode === 'roi' ? 'expectedROI' : 'roi';
      document.getElementById('strike-y-label').innerText = strikeYMode === 'roi' ? 'ROI' : 'ExpROI';
      buildStrikeTable(rawData);
      defaults.strike.h = dataRange(dtS, 0); defaults.strike.v = dataRange(dtS, 1);
      views.strike = {h: Object.assign({}, defaults.strike.h), v: Object.assign({}, defaults.strike.v)};
      redrawChart('strike');
    }

    function calculatePercentile(arr, p) {
      if (arr.length === 0) return 0;
      var sorted = arr.slice().sort(function(a, b) { return a - b; });
      var idx = (p / 100) * (sorted.length - 1);
      var lower = Math.floor(idx);
      var upper = Math.ceil(idx);
      if (lower === upper) return sorted[lower];
      return sorted[lower] + (idx - lower) * (sorted[upper] - sorted[lower]);
    }

    function draw(dataArray) {
      rawData = dataArray;
      if (!dataArray || dataArray.length === 0) return;

      // Calculate fitness percentile thresholds from actual data
      var fitnessValues = dataArray.filter(function(r) { return !r.held; }).map(function(r) { return r.fitness; });
      if (fitnessValues.length > 0) {
        fitnessPercentiles.p90 = calculatePercentile(fitnessValues, 90); // Top 10%
        fitnessPercentiles.p60 = calculatePercentile(fitnessValues, 60); // Top 40%
        fitnessPercentiles.p25 = calculatePercentile(fitnessValues, 25); // Top 75%
      }

      dtD = new google.visualization.DataTable();
      dtD.addColumn('number', 'X'); dtD.addColumn('number', 'ROI');
      dtD.addColumn({type: 'string', role: 'tooltip'}); dtD.addColumn({type: 'string', role: 'style'});

      dataArray.forEach(r => {
        dtD.addRow([r.delta, r.roi * 100, r.held ? r.label + ' [HELD]' : r.label, pointStyle(r)]);
      });
      buildStrikeTable(dataArray);

      // Set default ranges
      defaults.delta.h = dataRange(dtD, 0); defaults.delta.v = dataRange(dtD, 1);
      defaults.strike.h = dataRange(dtS, 0); defaults.strike.v = dataRange(dtS, 1);
      views.delta = {h: Object.assign({}, defaults.delta.h), v: Object.assign({}, defaults.delta.v)};
      views.strike = {h: Object.assign({}, defaults.strike.h), v: Object.assign({}, defaults.strike.v)};

      chartD = new google.visualization.ScatterChart(document.getElementById('chart_delta'));
      chartS = new google.visualization.ScatterChart(document.getElementById('chart_strike'));

      function updateAnalytics(rowIndex) {
        var t = rawData[rowIndex];
        document.getElementById('instruction').style.display = 'none';
        document.getElementById('data-content').style.display = 'block';
        var labelEl = document.getElementById('detail-label');
        labelEl.innerHTML = t.held ? t.label + '  <span data-help="You cannot be long and short on the same option" style="color:#ff9800;cursor:help;">⚠ HELD</span>' : t.label;
        labelEl.style.color = t.held ? '#ff9800' : '#8bc34a';
        document.getElementById('det-osurl').onclick = function() { window.open(t.osUrl, '_blank'); return false; };

        document.getElementById('det-width').innerText = t.width;
        document.getElementById('det-debit').innerText = "$" + Number(t.debit).toFixed(2);
        document.getElementById('det-maxp').innerText = "$" + Number(t.maxProfit).toFixed(2);
        document.getElementById('det-dte').innerText = t.dte + "d";
        document.getElementById('det-iv').innerText = t.iv ? (t.iv * 100).toFixed(1) + "%" : "—";
        document.getElementById('det-ld').innerText = t.lowerDelta;
        document.getElementById('det-ud').innerText = t.upperDelta;
        document.getElementById('det-loi').innerText = t.lowerOI;
        document.getElementById('det-uoi').innerText = t.upperOI;
        document.getElementById('det-liq').innerText = t.liquidity;

        var roiVal = t.roi * 100;
        var roiEl = document.getElementById('det-roi');
        roiEl.innerText = roiVal.toFixed(1) + "%";
        roiEl.style.color = roiVal >= 100 ? '#8bc34a' : (roiVal >= 50 ? '#ffeb3b' : '#f44336');

        var eroiVal = (t.expectedROI || 0) * 100;
        var eroiEl = document.getElementById('det-eroi');
        eroiEl.innerText = eroiVal.toFixed(1) + "%";
        eroiEl.style.color = eroiVal >= 100 ? '#8bc34a' : (eroiVal >= 50 ? '#ffeb3b' : '#f44336');

        var fitEl = document.getElementById('det-fit');
        fitEl.innerText = t.fitness;
        fitEl.style.color = t.fitness >= 4.0 ? '#8bc34a' : (t.fitness >= 3.0 ? '#66bb6a' : (t.fitness >= 2.0 ? '#ffeb3b' : '#f44336'));
      }

      [chartD, chartS].forEach(c => {
        google.visualization.events.addListener(c, 'select', function() {
          var sel = c.getSelection();
          if (sel.length > 0) updateAnalytics(sel[0].row);
        });
      });

      [document.getElementById('chart_delta'), document.getElementById('chart_strike')].forEach((el, idx) => {
        el.addEventListener('dblclick', function() {
          var c = idx === 0 ? chartD : chartS;
          var sel = c.getSelection();
          if (sel.length > 0) window.open(rawData[sel[0].row].osUrl, '_blank');
        });
      });

      // Track which chart is active for arrow-key panning
      ['chart_delta', 'chart_strike'].forEach(function(id) {
        var k = id === 'chart_delta' ? 'delta' : 'strike';
        document.getElementById(id).addEventListener('mouseenter', function() { activeKey = k; });
      });

      // Drag-to-zoom on chart divs
      ['chart_delta', 'chart_strike'].forEach(function(id) {
        var el = document.getElementById(id);
        var key = id === 'chart_delta' ? 'delta' : 'strike';
        var chart = key === 'delta' ? chartD : chartS;
        var dragStart = null;
        el.style.position = 'relative';

        // Selection box
        var selBox = document.createElement('div');
        selBox.style.cssText = 'position:absolute;border:2px dashed #1a73e8;background:rgba(26,115,232,0.1);display:none;z-index:11;pointer-events:none;';
        el.appendChild(selBox);

        el.addEventListener('mousedown', function(e) {
          activeKey = key;
          if (e.button !== 0 || e.shiftKey) return; // only left click, not shift (leave shift for select)
          // Check if click is in chart area (not on a point)
          var cli = chart.getChartLayoutInterface();
          var rect = el.getBoundingClientRect();
          var x = e.clientX - rect.left, y = e.clientY - rect.top;
          var ca = cli.getChartAreaBoundingBox();
          if (x < ca.left || x > ca.left + ca.width || y < ca.top || y > ca.top + ca.height) return;
          dragStart = {x: x, y: y, clientX: e.clientX, clientY: e.clientY};
          selBox.style.display = 'block';
          selBox.style.left = x + 'px'; selBox.style.top = y + 'px';
          selBox.style.width = '0'; selBox.style.height = '0';
          e.preventDefault();
        });

        el.addEventListener('mousemove', function(e) {
          if (!dragStart) return;
          var rect = el.getBoundingClientRect();
          var x = e.clientX - rect.left, y = e.clientY - rect.top;
          var sx = Math.min(dragStart.x, x), sy = Math.min(dragStart.y, y);
          var sw = Math.abs(x - dragStart.x), sh = Math.abs(y - dragStart.y);
          selBox.style.left = sx + 'px'; selBox.style.top = sy + 'px';
          selBox.style.width = sw + 'px'; selBox.style.height = sh + 'px';
          e.preventDefault();
        });

        el.addEventListener('mouseup', function(e) {
          if (!dragStart) return;
          selBox.style.display = 'none';
          var rect = el.getBoundingClientRect();
          var x2 = e.clientX - rect.left, y2 = e.clientY - rect.top;
          var sx = Math.min(dragStart.x, x2), ex = Math.max(dragStart.x, x2);
          var sy = Math.min(dragStart.y, y2), ey = Math.max(dragStart.y, y2);
          var dx = ex - sx, dy = ey - sy;
          dragStart = null;

          if (dx < 10 && dy < 10) return;

          var cli = chart.getChartLayoutInterface();
          var hMin = cli.getHAxisValue(sx), hMax = cli.getHAxisValue(ex);
          var vMax = cli.getVAxisValue(sy), vMin = cli.getVAxisValue(ey);

          if (hMin != null && hMax != null) views[key].h = {min: hMin, max: hMax};
          if (vMin != null && vMax != null) views[key].v = {min: vMin, max: vMax};
          redrawChart(key);
          e.preventDefault();
        });
      });

      redrawChart('delta');
      redrawChart('strike');

      // Arrow keys pan, right-click resets
      document.addEventListener('keydown', function(e) {
        if (!activeKey || ['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].indexOf(e.key) === -1) return;
        var axis = (e.key === 'ArrowLeft' || e.key === 'ArrowRight') ? views[activeKey].h : views[activeKey].v;
        var shift = (axis.max - axis.min) * 0.15 * ((e.key === 'ArrowRight' || e.key === 'ArrowUp') ? 1 : -1);
        axis.min += shift; axis.max += shift;
        redrawChart(activeKey);
        e.preventDefault();
      });

      // Right-click to reset zoom
      ['chart_delta', 'chart_strike'].forEach(function(id) {
        var key = id === 'chart_delta' ? 'delta' : 'strike';
        document.getElementById(id).addEventListener('contextmenu', function(e) {
          views[key].h = Object.assign({}, defaults[key].h);
          views[key].v = Object.assign({}, defaults[key].v);
          redrawChart(key);
          e.preventDefault();
        });
      });
    }
</script>
</body>
</html>